{% extends '@EasyAdmin/page/content.html.twig' %}
{% form_theme form '@EasyAdmin/crud/form_theme.html.twig' %}

{% block page_title %}
    {{ "Assistant de génération de trajets basé sur le Rapport de"|trans }} {{ report.getPeriod() }}
{% endblock %}

{% block page_actions %}
<a class="btn btn-secondary  action-index" href="{{ backUrl }}" role="button" data-action-name="index">
    <span class="icon btn-icon"><i class="fa fa-arrow-left"></i></span>
    <span class="btn-label"><span class="action-label">{{ "Retour"|trans }}</span></span>
</a>
{% endblock %}

{% block main %}

<article class="content">
    <section class="">
        <p class="fs-6">
          Cet assistant va vous permettre de dupliquer plusieurs trajets d'un coup pour compléter votre rapport d'IK mensuel ou pour en garnir un nouveau en quelques secondes.
        </p>
        <p class="fs-6">
          <span class="badge rounded-pill btn btn-primary fs-6">1</span> <span>Sélectionnez la tâche que doit accomplir l'assistant <i class="fa fa-arrow-right"></i></span>
          <span class="badge rounded-pill btn btn-primary fs-6">2</span> <span>Prévisualisez les trajets <i class="fa fa-arrow-right"></i></span>
          <span class="badge rounded-pill btn btn-primary fs-6">3</span> <span>Validez ou Modifiez votre saisie.</span>
        </p>  
    </section>

    <section class="content-body">
        <div class="card shadow-sm w-75" >
            <div class="card-header">
                <h4><i class="fa-solid fa-wand-magic-sparkles"></i> Assistant</h4>
            </div>

            <div class="card-body">

            {{ form_start(form, {'attr': {'id': 'assistant-form'}}) }}
                
                {{ form_row(form.action) }}

                {{ include('App/Report/_assistant_form.html.twig') }}
                
                {# Bouton de soumission avec spinner #}
                <button type="submit" class="btn btn-primary mt-3" id="preview-button">
                    <span id="button-text"><i class="fa fa-eye"></i> {{ "Prévisualiser"|trans }}</span>
                    <span id="button-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <span id="button-loading-text" class="d-none">{{ "Génération des trajets en cours..."|trans }}</span>
                </button>

            {{ form_end(form) }}
                
            </div>
        </div>

        {# templates/admin/assistant.html.twig #}
        <div id="preview-zone" style="display: none;"></div>

    </section>
</article>
<script>

document.querySelectorAll('input[name="assistant_ai[action]"]').forEach(function(radio) {
    radio.addEventListener('change', function(e) {
        //const action = this.value;
        const form = document.getElementById('assistant-form');
        const formData = new FormData(form);
        const formContainer = document.getElementById('assistant-form-container');

        // Afficher un spinner ou un message de chargement
        formContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

        // Requête AJAX pour récupérer le formulaire mis à jour
        fetch("{{ actionAjaxUrl|raw }}", {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
            method: 'POST',
        })
        .then(response => response.text())
        .then(data => {
            // Créer un DOMParser pour parser le HTML reçu
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, 'text/html');

            // Extraire le bloc avec l'ID "assistant-form-container"
            const assistantFormContainer = doc.getElementById('assistant-form-container');

            if (assistantFormContainer) {
                // Mettre à jour le contenu de votre page avec ce bloc
                formContainer.innerHTML = assistantFormContainer.innerHTML;
            } else {
                console.error("Le bloc n'a pas été trouvé dans la réponse.");
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            formContainer.innerHTML = '<div class="alert alert-danger">Erreur lors du chargement du formulaire.</div>';
        });
    });
});

document.getElementById('assistant-form').addEventListener('submit', function(e) {
    e.preventDefault();
    //console.log('submitted');
    const form = e.target;
    const formData = new FormData(form);
    const previewButton = document.getElementById('preview-button');
    previewButton.disabled = true;
    document.getElementById('button-text').classList.add('d-none');
    document.getElementById('button-spinner').classList.remove('d-none');
    document.getElementById('button-loading-text').classList.remove('d-none');

    fetch("{{ actionUrl|raw }}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .catch(error => {
        console.error('Erreur:', error);
        document.getElementById('preview-zone').innerHTML =
            '<div class="alert alert-danger">Une erreur est survenue. Veuillez réessayer.</div>';
        document.getElementById('preview-zone').style.display = 'block';
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('preview-zone').innerHTML = html;
        document.getElementById('preview-zone').style.display = 'block';
    })
    .finally(() => {
        // Réactiver le bouton et masquer le spinner
        previewButton.disabled = false;
        document.getElementById('button-text').classList.remove('d-none');
        document.getElementById('button-spinner').classList.add('d-none');
        document.getElementById('button-loading-text').classList.add('d-none');
    });
});

</script>

{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}
