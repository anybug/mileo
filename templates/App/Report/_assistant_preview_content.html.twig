{# templates/admin/_assistant_preview_content.html.twig #}
<div class="alert alert-info w-75 mt-3">
    <div>
        <strong>Prévisualisation des trajets à ajouter au Rapport de {{ report.getPeriod() }}</strong>
        <span class="badge rounded-pill bg-primary text-light">

            {% if previewTrips|length > 0 %}
                <i class="fa fa-plus me-1">{{ previewTrips|length }}</i> 
                {% if previewTrips|length > 1 %}
                    {{ "trajets"|trans }}
                {% else %}
                    {{ "trajet"|trans }}
                {% endif %}

            {% else %}
                {{ "Aucun trajet possible"|trans }}
            {% endif %}  

        </span>    
    </div>
    
</div>

<table class="table table-bordered w-75">
    <thead>
        <tr>
            <th style="display: none"></th>
            <th>Date</th>
            <th>Départ</th>
            <th>Arrivée</th>
            <th>Km</th>
            <th>Aller-retour</th>
            <th>Km total</th>
            <th style="display: none">Véhicule</th>
            <th>Montant</th>
            <th>Commentaire</th>
        </tr>
    </thead>
    <tbody>
        {% for trip in previewTrips %}
        <tr>
            <td class="d-none">{{ trip.date }}</td>
            <td class="text-nowrap">{{ trip.date|date('l')|trans }} <br /> {{ trip.date|date('d/m/Y') }}</td>
            <td class="d-none">{{ trip.start }}</td>
            <td class="d-none">{{ trip.end }}</td>
            <td>{{ trip.formattedStart|raw }}</td>
            <td>{{ trip.formattedEnd|raw }}</td>
            <td>{{ trip.km }}</td>
            <td>{{ trip.is_return ? 'Oui' : 'Non' }}</td>
            <td>{{ trip.km_total }}</td>
            <td class="d-none">{{ trip.vehicule_id }}</td>
            <td>{{ trip.amount }} €</td>
            <td>{{ trip.comment }}</td>
        </tr>
        {% else %}
        <tr>
            <td colspan="9">Aucun trajet à prévisualiser.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if previewTrips|length > 0 %}
{# Formulaire de confirmation #}
<form method="POST" action="{{ confirmActionUrl }}">
    {# Champ caché pour les données des trajets #}
    <input type="hidden" name="trips" value="{{ previewTrips|json_encode|e('html_attr') }}">

    {% if action == 'duplicate_report' %}
        <input type="hidden" name="target_period" value="{{ targetPeriod }}">
        <input type="hidden" name="copy_mode" value="{{ copyMode|default('week_for_week') }}">
    {% endif %}

    {# Boutons de confirmation/annulation #}
    <div class="mt-3">
        <button type="submit" class="btn btn-success js-confirm-dup">
            <i class="fa fa-check"></i> Confirmer la création des trajets
        </button>
        <a href="{{ backUrl }}" class="btn btn-danger">
            <i class="fa fa-times"></i> Annuler
        </a>
    </div>
</form>
{% endif %}

<script>
  (function () {
    const btn = document.querySelector('.js-confirm-dup');
    if (!btn) return;

    btn.addEventListener('click', function (e) {
      if (btn.dataset.submitted === '1') {
        e.preventDefault();
        return;
      }
      btn.dataset.submitted = '1';
      btn.disabled = true;
    }, { once: true });
  })();
</script>

